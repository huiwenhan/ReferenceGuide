Architectural Overview
======================

CQRS本身就是一个非常简单的模式。 它只规定处理命令的应用程序组件应与处理查询的组件分离。 虽然这种分离本身非常简单，但是当与其他模式结合使用时，它提供了许多非常强大的功能。 Axon提供了构建模块，可以更轻松地实现可与CQRS结合使用的不同模式。

下图显示了基于CQRS的事件驱动架构的扩展布局示例。 显示在左侧的UI组件以两种方式与应用程序的其余部分交互：它向应用程序发送命令（如上部分所示），并向应用程序查询信息（如下部分所示）。

![Architecture overview of a CQRS application](detailed-architecture-overview.png)

命令通常由简单而直接的对象表示，这些对象包含执行命令处理程序所需的全部数据。 命令通过其名称表达其意图。 用Java语言来说，这意味着使用类名来确定需要完成什么，并且命令的各个字段提供了执行此操作所需的信息。

命令总线接收命令并将它们路由到命令处理程序。 每个命令处理程序都会响应特定类型的命令，并根据命令的内容执行逻辑。 但是，在某些情况下，无论命令的实际类型如验证，日志记录或授权，您也希望执行逻辑。

命令处理程序从存储库中检索域对象（聚合）并执行它们上的方法来更改它们的状态。 这些聚合通常包含实际的业务逻辑，因此负责保护自己的不变量。 聚合的状态变化导致产生域事件。 域事件和聚合形成域模型。

存储库负责提供对聚合的访问。 通常，这些存储库仅针对通过其唯一标识符查找聚合进行了优化。 一些存储库将存储聚合本身的状态（例如使用对象关系映射），而另一些存储聚合在事件存储中经历的状态更改。 存储库还负责在其后备存储中保留对聚合所做的更改。

Axon提供对持久聚合的直接方式（例如使用对象关系映射）和事件溯源的支持。

事件总线将事件分派给所有感兴趣的事件监听者。 这可以同步或异步完成。 异步事件分派允许命令执行返回并将控制移交给用户，而事件正在后台调度和处理。 无需等待事件处理完成，可以使应用程序更具响应性。 另一方面，同步事件处理更简单并且是一个合理的默认设置。 默认情况下，同步处理将在也处理命令的同一事务中处理事件侦听器。

事件侦听器接收事件并处理它们。 一些处理程序将更新用于查询的数据源，而另一些则将消息发送到外部系统。 您可能会注意到，命令处理程序完全不了解对其所做更改感兴趣的组件。 这意味着用新功能扩展应用程序是非常不干扰的。 您只需添加另一个事件侦听器即可。 事件将应用程序中的所有组件松散地耦合在一起。

在某些情况下，事件处理需要将新命令发送给应用程序。 一个例子是收到订单时。 这可能意味着客户的账户应该以购买金额记帐，并且必须通知运送准备运送所购买的商品。 在许多应用中，逻辑将变得比这更复杂：如果客户没有及时付款，该怎么办？ 您会立即寄出货物，还是先等待付款？ 这个Saga是负责管理这些复杂商业交易的CQRS概念。

自从Axon 3.1框架提供了处理查询的组件。 查询总线接收查询并将它们路由到查询处理程序。 查询处理程序在查询总线处注册，处理的查询类型以及响应提供程序的类型。 查询和结果类型通常都是简单的只读DTO对象。 这些DTO的内容通常由用户界面的需求驱动。 在大多数情况下，它们直接映射到UI中的特定视图（也称为“按视图”）。

可以为同一类型的查询和响应类型注册多个查询处理程序。 当分派查询时，客户可以指示他是想要一个结果还是来自所有可用的查询处理程序。

Axon Module Structure
=====================

Axon框架由一些针对CQRS特定问题领域的模块组成。 根据项目的确切需要，您需要包含一个或多个这些模块。

从Axon 2.1开始，所有模块都是OSGi兼容的软件包。 这意味着它们在清单文件中包含必需的头文件并声明它们导入和导出的包。 此刻，仅需要Slf4J捆绑包（1.7.0 <=版本<2.0.0）。 所有其他进口都标记为可选，尽管您很可能需要其他进口。

Main modules
------------

Axon的主要模块是经过全面测试的模块，并且足够坚固，可用于要求苛刻的生产环境。 所有这些模块的maven groupId都是`org.axonframework`。

正如其名称所示，核心模块包含了Axon的核心组件。 如果您使用单节点安装程序，则该模块可能会提供您需要的所有组件。 所有其他的Axon模块都依赖于这个模块，所以它必须始终在类路径中可用。

测试模块包含可用于测试基于Axon的组件的测试装置，例如您的命令处理程序，聚集和Sagas。 您通常在运行时不需要此模块，只需在测试期间将其添加到类路径中即可。

分布式CommandBus模块包含可用于在多个节点上分发命令的实现。 它带有用于连接这些节点的JGroups和Spring Cloud连接器。

AMQP模块提供的组件允许您使用基于AMQP的消息代理作为分发机制来构建EventBus。 这允许保证传送，即使事件处理程序节点暂时不可用。

Spring模块允许在Spring应用程序上下文中配置Axon组件。 它还提供了许多特定于Spring Framework的构建块实现，例如用于在Spring消息通道上发布和检索Axon事件的适配器。

MongoDB是一个基于文档的NoSQL数据库。 Mongo模块提供Event和Saga Store实现，将事件流和Saga存储在MongoDB数据库中。

几个AxonFramework组件提供监视信息。 度量模块提供了基于Codehale的基本实现来收集监控信息。

Working with Axon APIs
======================

CQRS是一种架构模式，无法提供适合所有项目的单一解决方案。 显然，Axon框架并不试图提供这种解决方案。 取而代之的是，Axon提供了遵循最佳实践的实现方法，以及根据您的具体要求调整每个实现的方法。

几乎所有的基础设施构建块都会提供钩子点（例如拦截器，解析器等），允许您将特定于应用程序的行为添加到这些构建块。 在很多情况下，Axon将为那些适合大多数用例的钩子点提供实现。 如果需要，你可以简单地实现你自己的。

非基础结构对象（如消息）通常是不可变的。 这确保了这些对象可以安全地在多线程环境中使用，而没有副作用。

为确保最大限度的定制，所有的Axon组件都使用接口进行定义。 提供了抽象和具体的实现来帮助你在路上，但框架将无处可用。 始终可以使用该接口构建任何构建块的完全自定义实现。

Spring Support
==============

Axon Framework为Spring提供了广泛的支持，但并不要求您使用Spring来使用Axon。 所有组件都可以通过编程进行配置，并且不需要类路径中的Spring。 但是，如果你使用Spring，通过使用Spring的注解支持，许多配置变得更加容易。
